<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Registro de peso (mínimo)</title>
<link rel="icon" href="data:,">
</head>
<body>
<h1>Registro de peso (mínimo)</h1>

<!-- LOGIN -->
<section id="loginSec">
  <h2>Accede</h2>
  <form id="loginForm">
    <label>ID de usuario <input id="userId" required></label>
    <label>Token <input id="token" type="password" required></label>
    <button type="submit">Entrar</button>
  </form>
  <p>También puedes entrar con la URL: <code>?userId=ana&token=ABC</code></p>
</section>

<!-- APP -->
<section id="appSec" style="display:none">
  <p>
    <button id="logoutBtn">Cerrar sesión</button>
  </p>
  <h2>Nuevo registro</h2>
  <label>Peso (kg) <input id="peso" type="number" step="0.1" min="20" max="400" inputmode="decimal"></label>
  <button id="addBtn">Registrar</button>

  <h2>Histórico</h2>
  <table border="1" cellpadding="6">
    <thead><tr><th>Fecha (dd/mm/yyyy)</th><th>Peso (kg)</th></tr></thead>
    <tbody id="histBody"></tbody>
  </table>
</section>

<hr>
<pre id="status" style="white-space:pre-wrap;background:#f5f5f5;padding:8px;border:1px solid #ddd"></pre>

<script>
const APP_SCRIPT_URL = "YOUR_WEB_APP_URL_HERE"; // <-- pon aquí tu /exec

// Utilidades
const $ = id => document.getElementById(id);
const show = (el, v) => el.style.display = v ? '' : 'none';
const okURL = u => /^https?:\/\/.+\/exec(\b|$)/.test(u || "");
const fmtES = d => new Date(d).toLocaleDateString("es-ES",{day:'2-digit',month:'2-digit',year:'numeric', timeZone:'Europe/Madrid'});
const setCreds = (u,t)=>{localStorage.setItem('userId',u);localStorage.setItem('token',t);}
const getCreds = ()=>({userId:localStorage.getItem('userId'),token:localStorage.getItem('token')});
const clearCreds = ()=>{localStorage.removeItem('userId');localStorage.removeItem('token');}

// API
async function apiList(userId, token, limit=180){
  if(!okURL(APP_SCRIPT_URL)) throw new Error("https://script.google.com/macros/s/AKfycbw2gm7eFC6ubXG1Wzbhtjbu_jX-9SoJh7sSNRbj_7SKSLc-aJfqUEO1cHrKsLBd4CxO-Q/exec");
  const url = new URL(APP_SCRIPT_URL);
  url.searchParams.set("action","list");
  url.searchParams.set("userId", userId);
  url.searchParams.set("token", token);
  url.searchParams.set("limit", String(limit));
  const r = await fetch(url);
  const t = await r.text();
  try { return JSON.parse(t); } catch { throw new Error("Respuesta no JSON del backend: "+t.slice(0,120)); }
}
async function apiAdd(userId, token, weight){
  if(!okURL(APP_SCRIPT_URL)) throw new Error("APP_SCRIPT_URL no configurada o sin /exec");
  const r = await fetch(APP_SCRIPT_URL, {
    method:"POST", headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ action:"add", userId, token, weight })
  });
  const t = await r.text();
  try { return JSON.parse(t); } catch { throw new Error("Respuesta no JSON del backend: "+t.slice(0,120)); }
}

// UI
function log(msg){ $("status").textContent = msg; }
function renderRows(items){
  const tb = $("histBody"); tb.innerHTML = "";
  (items||[]).forEach(row=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${row.date}</td><td>${row.weight}</td>`;
    tb.appendChild(tr);
  });
}
async function loadHistory(){
  const {userId, token} = getCreds();
  if(!userId || !token) return;
  log("Cargando histórico…");
  try{
    const data = await apiList(userId, token);
    if(data.ok){ renderRows(data.items||[]); log(`OK: ${ (data.items||[]).length } registros.`); }
    else { log("Error backend: "+(data.error||"desconocido")); }
  }catch(e){ log("Fallo list: "+e.message); }
}
async function addWeight(){
  const {userId, token} = getCreds();
  const v = String($("peso").value||"").replace(",",".");
  const w = Number(v);
  if(!isFinite(w) || w<20 || w>400){ log("Peso inválido (20–400)."); $("peso").focus(); return; }
  log("Guardando…");
  try{
    const data = await apiAdd(userId, token, w);
    if(data.ok){ $("peso").value=""; await loadHistory(); log("Registro guardado."); }
    else { log("Error backend: "+(data.error||"desconocido")); }
  }catch(e){ log("Fallo add: "+e.message); }
}

// Auth flow
function enterApp(){
  show($("loginSec"), false);
  show($("appSec"), true);
  loadHistory();
}
function leaveApp(){
  show($("appSec"), false);
  show($("loginSec"), true);
  $("histBody").innerHTML = "";
}

// Eventos
$("loginForm").addEventListener("submit",(ev)=>{
  ev.preventDefault();
  const u = $("userId").value.trim();
  const t = $("token").value.trim();
  if(!u || !t){ log("Completa ID y token."); return; }
  setCreds(u,t);
  enterApp();              // <- se entra SIEMPRE
  log("Sesión iniciada.");
});
$("logoutBtn").addEventListener("click",()=>{ clearCreds(); leaveApp(); log("Sesión cerrada."); });
$("addBtn").addEventListener("click", addWeight);

// Init
(function init(){
  // Soporta login por query
  const url = new URL(location.href);
  const u = url.searchParams.get("userId");
  const t = url.searchParams.get("token");
  if(u && t){ setCreds(u,t); }

  const {userId, token} = getCreds();
  if(userId && token) enterApp(); else leaveApp();

  if(!okURL(APP_SCRIPT_URL)) log("⚠️ Configura APP_SCRIPT_URL (debe terminar en /exec).");
})();
</script>
</body>
</html>
