<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Peso (kg)</title>
  <link rel="icon" href="data:,">
  <style>
    :root { --bg:#0b1020; --card:#141b34; --muted:#8ea0b6; --text:#eaf0ff; --accent:#7aa2ff; --danger:#ff6b6b; --ok:#47d16f; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#0e1530);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;}
    .wrap{max-width:720px;margin:40px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    header{padding:20px 20px 0}
    header h1{margin:0;font-size:1.35rem}
    header p{margin:.25rem 0 1rem;color:var(--muted)}
    .content{padding:20px}
    label{display:block;margin:.25rem 0 .35rem}
    input[type="text"],input[type="password"],input[type="number"]{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:#0c1330;color:var(--text);font-size:1rem;outline:none;
    }
    input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
    .row{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:end}
    button{
      cursor:pointer;border:1px solid rgba(255,255,255,.12);padding:12px 16px;border-radius:12px;
      background:var(--accent);color:#0b1020;font-weight:600
    }
    button[disabled]{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--danger)}
    table{width:100%;border-collapse:collapse;margin-top:16px;background:#0c1330;border-radius:12px;overflow:hidden}
    th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
    th{font-weight:600;color:#c9d7ff;background:#0f1740}
    tr:last-child td{border-bottom:none}
    .actions{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:12px}
    .pill{padding:6px 10px;border-radius:999px;background:#0f1740;border:1px solid rgba(255,255,255,.1);font-size:.9rem}
    .center{display:flex;justify-content:center;align-items:center;gap:8px}
    .hide{display:none}
    .footer{padding:0 20px 20px}
    .login-backdrop{ position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter: blur(3px);display:flex;align-items:center;justify-content:center;padding:16px }
    .login{width:100%;max-width:420px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h1>Registro diario de peso</h1>
        <p class="muted">Introduce tu peso en <strong>kg</strong>. La fecha se guarda automáticamente (dd/mm/yyyy).</p>
      </header>
      <div class="content">
        <div class="actions">
          <span id="today" class="pill">Hoy: —/—/—</span>
          <div class="center"><button id="logoutBtn" class="hide" title="Cerrar sesión">Cerrar sesión</button></div>
        </div>

        <div class="row" style="margin-top:14px">
          <div>
            <label for="peso">Peso (kg)</label>
            <input id="peso" type="number" inputmode="decimal" step="0.1" min="20" max="400" placeholder="Ej: 72.4" autocomplete="off" />
            <small class="muted">Usa punto o coma para decimales.</small>
          </div>
          <div><button id="addBtn">Registrar</button></div>
        </div>

        <p id="status" class="muted" aria-live="polite" style="margin:12px 0 0"></p>

        <table id="histTable" class="hide" aria-label="Histórico de pesos">
          <thead><tr><th>Fecha (dd/mm/yyyy)</th><th>Peso (kg)</th></tr></thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>
      <div class="footer"><p class="muted" style="margin:0.75rem 0 0">Tus datos se envían de forma segura al registro de tu nutricionista.</p></div>
    </div>
  </div>

  <!-- Modal de acceso con FORM -->
  <div class="login-backdrop" id="loginModal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="card login">
      <div class="content">
        <h2 id="loginTitle" style="margin-top:0">Accede a tu registro</h2>
        <p class="muted" style="margin-top:0">Introduce tu <strong>id de usuario</strong> y tu <strong>token</strong>.</p>
        <form id="loginForm" style="display:grid;gap:12px">
          <div><label for="userId">ID de usuario</label><input id="userId" name="userId" type="text" placeholder="Ej: ana" autocomplete="username" required /></div>
          <div><label for="token">Token</label><input id="token" name="token" type="password" placeholder="Tu token personal" autocomplete="current-password" required /></div>
          <button id="loginBtn" type="submit">Entrar</button>
          <small class="muted">También puedes abrir con <code>?userId=ana&token=TU_TOKEN</code>.</small>
        </form>
      </div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbztzYHIJTgX6ByuFE5dQ6IQ5XKy75VjXOa5pEAVYcy2M0zkiEqdmxHrbBfh3xO3YNUG/exec"; // <- pega aquí la URL /exec del deployment NUEVO
    const DATE_LOCALE = "es-ES"; const TZ = "Europe/Madrid";

    // ========= Utils =========
    const el = id => document.getElementById(id);
    const okURL = u => /^https?:\/\/.+\/exec(\b|$)/.test(u||"");
    const show = (node, v=true) => node && node.classList.toggle("hide", !v);
    const fmtDate = d => new Date(d).toLocaleDateString(DATE_LOCALE, {day:'2-digit',month:'2-digit',year:'numeric', timeZone:TZ});
    const normalize = v => { const n=Number(String(v||"").trim().replace(",",".")); return Number.isFinite(n)?n:null; };
    const setCreds = ({userId, token}) => { localStorage.setItem("userId", userId); localStorage.setItem("token", token); };
    const getCreds = () => ({ userId: localStorage.getItem("userId"), token: localStorage.getItem("token") });
    const clearCreds = () => { localStorage.removeItem("userId"); localStorage.removeItem("token"); };
    function renderToday(){ el("today").textContent = "Hoy: " + fmtDate(Date.now()); }
    function renderStatus(msg, cls="muted"){ el("status").textContent = msg; el("status").className = cls; }
    function renderTable(rows){ const tb=el("histBody"); tb.innerHTML=""; (rows||[]).forEach(r=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td>${r.date}</td><td>${r.weight}</td>`; tb.appendChild(tr); }); show(el("histTable"), (rows||[]).length>0); }
    function hideModal(){ const m=el("loginModal"); if(!m) return; m.classList.add("hide"); m.style.display="none"; m.setAttribute("aria-hidden","true"); }
    function showModal(){ const m=el("loginModal"); if(!m) return; m.classList.remove("hide"); m.style.display="flex"; m.removeAttribute("aria-hidden"); }

    // ========= API helpers: parse robusto =========
    async function parseJSONResponse(res){
      const txt = await res.text();
      // 1) JSON estándar
      try { return JSON.parse(txt); } catch {}
      // 2) Respuesta tipo "data=...json-url-encoded..."
      if (txt.startsWith("data=")) {
        try { const decoded = decodeURIComponent(txt.slice(5)); return JSON.parse(decoded); } catch {}
      }
      // 3) Falla: devolvemos error con cuerpo recortado
      throw new Error("Respuesta no JSON del backend: " + txt.slice(0,120));
    }

    async function apiList(userId, token, limit=180){
      if (!okURL(APP_SCRIPT_URL)) throw new Error("Configura APP_SCRIPT_URL (debe acabar en /exec).");
      const url = new URL(APP_SCRIPT_URL);
      url.searchParams.set("action","list");
      url.searchParams.set("userId", userId);
      url.searchParams.set("token", token);
      url.searchParams.set("limit", String(limit));
      const res = await fetch(url.toString());
      return parseJSONResponse(res);
    }

    // POST sin preflight (x-www-form-urlencoded)
    async function apiAdd(userId, token, weight){
      if (!okURL(APP_SCRIPT_URL)) throw new Error("Configura APP_SCRIPT_URL (debe acabar en /exec).");
      const payload = { action:"add", userId, token, weight };
      const body = new URLSearchParams({ data: JSON.stringify(payload) });
      const res = await fetch(APP_SCRIPT_URL, {
        method:"POST",
        headers: { "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
        body: body.toString()
      });
      return parseJSONResponse(res);
    }

    // ========= App =========
    async function loadHistory(){
      const { userId, token } = getCreds();
      if (!userId || !token) return;
      renderStatus("Cargando histórico…");
      try{
        const data = await apiList(userId, token);
        if (data.ok){ renderTable(data.items||[]); renderStatus(`Histórico cargado (${(data.items||[]).length}).`); }
        else { renderStatus(data.error || "No se pudo cargar el histórico.", "err"); }
      }catch(e){ renderStatus(e.message || "Error al cargar histórico.", "err"); }
    }

    async function handleAdd(){
      const { userId, token } = getCreds();
      if (!userId || !token){ renderStatus("Primero inicia sesión.", "err"); showModal(); return; }
      const w = normalize(el("peso").value);
      if (w==null || w<20 || w>400){ renderStatus("Introduce un peso válido (20–400 kg).", "err"); el("peso").focus(); return; }
      el("addBtn").disabled = true; renderStatus("Guardando…");
      try{
        const data = await apiAdd(userId, token, w);
        if (data.ok){ el("peso").value=""; renderStatus("Registro guardado.", "ok"); await loadHistory(); }
        else { renderStatus(data.error || "No se pudo guardar.", "err"); }
      }catch(e){ renderStatus(e.message || "Error de red/servidor.", "err"); }
      finally{ el("addBtn").disabled = false; }
    }

    function syncCredsFromQuery(){
      const url = new URL(location.href);
      const u = url.searchParams.get("userId");
      const t = url.searchParams.get("token");
      if (u && t) setCreds({ userId:u, token:t });
    }

    async function updateAuthUI(){
      const { userId, token } = getCreds();
      const logged = !!(userId && token);
      if (logged){ hideModal(); el("logoutBtn").classList.remove("hide"); await loadHistory(); }
      else { showModal(); el("logoutBtn").classList.add("hide"); }
    }

    // ========= Eventos / init =========
    window.addEventListener("DOMContentLoaded", () => {
      el("today").textContent = "Hoy: " + fmtDate(Date.now());
      syncCredsFromQuery();
      updateAuthUI();

      el("loginForm")?.addEventListener("submit", (e) => {
        e.preventDefault();
        const userId = el("userId").value.trim();
        const token  = el("token").value.trim();
        if (!userId || !token){ renderStatus("Completa ID y token.", "err"); return; }
        setCreds({ userId, token });
        hideModal(); el("logoutBtn").classList.remove("hide");
        renderStatus("Sesión iniciada. Cargando histórico…");
        updateAuthUI();
      });

      el("logoutBtn").addEventListener("click", () => {
        clearCreds(); renderTable([]); renderStatus("Sesión cerrada."); showModal(); el("logoutBtn").classList.add("hide");
      });

      el("addBtn").addEventListener("click", handleAdd);
      el("peso").addEventListener("keydown", e => { if (e.key==="Enter") handleAdd(); });

      if (!okURL(APP_SCRIPT_URL)){ renderStatus("⚠️ APP_SCRIPT_URL no válida (debe terminar en /exec).", "err"); }
    });

    window.addEventListener("error", ev => { console.error(ev.error || ev.message); renderStatus("Error: " + (ev.message || "consulta consola"), "err"); });
  </script>
</body>
</html>
