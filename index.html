<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Peso (kg)</title>

  <!-- CSS externo -->
  <link rel="stylesheet" href="./assets/css/styles.css">

  <!-- Favicon (evita 404 si no tienes uno) -->
  <link rel="icon" href="data:,">

  <!-- Pre-carga del logo -->
  <link rel="preload" as="image" href="./assets/img/logo-texto-con-fondo.png?v=1" />

  <!-- Opcional: hint de conexi√≥n hacia Apps Script -->
  <link rel="preconnect" href="https://script.google.com" crossorigin>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- CABECERA CON LOGO COMO T√çTULO -->
      <header class="brand-header">
        <img
          src="./assets/img/logo-texto-con-fondo.png?v=1"
          alt="Registro diario de peso ‚Äî Tu marca"
          class="brand-logo"
          loading="eager"
          decoding="async"
        />
        <!-- H1 oculto para accesibilidad y SEO -->
        <h1 class="sr-only">Registro diario de peso</h1>

        <p class="muted">Introduce tu peso en <strong>kg</strong>. La fecha se guarda autom√°ticamente (dd/mm/yyyy).</p>
      </header>

      <div class="content">
        <div class="actions">
          <span id="today" class="pill">Hoy: ‚Äî/‚Äî/‚Äî</span>
          <div class="center">
            <button id="logoutBtn" type="button" class="hide" title="Cerrar sesi√≥n">Cerrar sesi√≥n</button>
          </div>
        </div>

        <div class="row" style="margin-top:14px">
          <div>
            <label for="peso">Peso (kg)</label>
            <input
              id="peso"
              type="number"
              inputmode="decimal"
              enterkeyhint="done"
              step="0.1"
              min="20"
              max="400"
              placeholder="Ej: 72.4"
              autocomplete="off"
            />
            <small class="muted" id="pesoHelp">Usa punto o coma para decimales.</small>
          </div>
          <div>
            <button id="addBtn" type="button">Registrar</button>
          </div>
        </div>

        <p id="status" class="muted" role="status" aria-live="polite" aria-atomic="true" style="margin:12px 0 0"></p>

        <table id="histTable" class="hide" aria-label="Hist√≥rico de pesos">
          <thead>
            <tr>
              <th>Fecha (dd/mm/yyyy)</th>
              <th>Peso (kg)</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>

      <div class="footer">
        <p class="muted" style="margin:0.75rem 0 0">Tus datos se env√≠an de forma segura al registro de tu nutricionista.</p>
      </div>
    </div>
  </div>

  <!-- Modal de acceso con FORM (soporta Enter) -->
  <div class="login-backdrop" id="loginModal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="card login">
      <div class="content">
        <h2 id="loginTitle" style="margin-top:0">Accede a tu registro</h2>
        <p class="muted" style="margin-top:0">Introduce tu <strong>id de usuario</strong> y tu <strong>token</strong>.</p>
        <form id="loginForm" style="display:grid;gap:12px" autocomplete="on">
          <div>
            <label for="userId">ID de usuario</label>
            <input id="userId" name="userId" type="text" placeholder="Ej: ana" autocomplete="username" required />
          </div>
          <div>
            <label for="token">Token</label>
            <input id="token" name="token" type="password" placeholder="Tu token personal" autocomplete="current-password" required />
          </div>
          <button id="loginBtn" type="submit">Entrar</button>
          <small class="muted">Tambi√©n puedes abrir con <code>?userId=ana&token=TU_TOKEN</code>.</small>
        </form>
      </div>
    </div>
  </div>

  <!-- ===================== JS ===================== -->
  <script>
    // ========= CONFIG =========
    const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxKdPLwPSupjMsZDh2r53_jHcZWWY1_FYDHWaAUrih1zYlOqTGvigSeZCB8YzwX_ciT/exec"; // ‚Üê pega aqu√≠ tu URL /exec vigente
    const DATE_LOCALE = "es-ES";
    const TZ = "Europe/Madrid";

    // ========= Utils =========
    const el = id => document.getElementById(id);
    const okURL = u => /^https?:\/\/.+\/exec(\b|$)/.test(u||"");
    const show = (node, v=true) => node && node.classList.toggle("hide", !v);
    const fmtDate = d => new Date(d).toLocaleDateString(DATE_LOCALE, {day:'2-digit',month:'2-digit',year:'numeric', timeZone:TZ});
    const normalize = v => { const n=Number(String(v||"").trim().replace(",", ".")); return Number.isFinite(n)?n:null; };

    const setCreds = ({userId, token}) => { localStorage.setItem("userId", userId); localStorage.setItem("token", token); };
    const getCreds = () => ({ userId: localStorage.getItem("userId"), token: localStorage.getItem("token") });
    const clearCreds = () => { localStorage.removeItem("userId"); localStorage.removeItem("token"); };

    function renderToday(){ el("today").textContent = "Hoy: " + fmtDate(Date.now()); }
    function renderStatus(msg, cls="muted"){ const s=el("status"); s.textContent = msg; s.className = cls; }

    // ========= Parse robusto (por si alg√∫n deployment devuelve data=...) =========
    async function parseJSONResponse(res){
      const txt = await res.text();
      try { return JSON.parse(txt); } catch {}
      if (txt.startsWith("data=")) { try { return JSON.parse(decodeURIComponent(txt.slice(5))); } catch {} }
      throw new Error("Respuesta no JSON del backend: " + txt.slice(0,120));
    }

    // ========= API =========
    async function apiList(userId, token, limit=180){
      if (!okURL(APP_SCRIPT_URL)) throw new Error("Configura APP_SCRIPT_URL (debe acabar en /exec).");
      const url = new URL(APP_SCRIPT_URL);
      url.searchParams.set("action","list");
      url.searchParams.set("userId", userId);
      url.searchParams.set("token", token);
      url.searchParams.set("limit", String(limit));
      const res = await fetch(url.toString());
      return parseJSONResponse(res);
    }

    // POST sin preflight (x-www-form-urlencoded)
    async function apiAdd(userId, token, weight){
      if (!okURL(APP_SCRIPT_URL)) throw new Error("Configura APP_SCRIPT_URL (debe acabar en /exec).");
      const body = new URLSearchParams({ data: JSON.stringify({ action:"add", userId, token, weight }) });
      const res = await fetch(APP_SCRIPT_URL, {
        method:"POST",
        headers: { "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
        body: body.toString()
      });
      return parseJSONResponse(res);
    }

    // ‚ùå Eliminar registro (por n√∫mero de fila real en la hoja)
    async function apiDelete(userId, token, row){
      if (!okURL(APP_SCRIPT_URL)) throw new Error("Configura APP_SCRIPT_URL (debe acabar en /exec).");
      const body = new URLSearchParams({ data: JSON.stringify({ action:"delete", userId, token, row }) });
      const res = await fetch(APP_SCRIPT_URL, {
        method:"POST",
        headers: { "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
        body: body.toString()
      });
      return parseJSONResponse(res);
    }

    // ========= Render =========
    function renderTable(rows){
      const tb = el("histBody");
      tb.innerHTML = "";
      (rows||[]).forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.date}</td>
          <td>${r.weight}</td>
          <td>
            <button class="btn-del btn-small" type="button" data-row="${r.row}" data-date="${r.date}" data-weight="${r.weight}" title="Eliminar">üóëÔ∏è Eliminar</button>
          </td>
        `;
        tb.appendChild(tr);
      });
      show(el("histTable"), (rows||[]).length>0);
    }

    async function loadHistory(){
      const { userId, token } = getCreds();
      if (!userId || !token) return;
      renderStatus("Cargando hist√≥rico‚Ä¶");
      try{
        const data = await apiList(userId, token);
        if (data.ok){ renderTable(data.items||[]); renderStatus(`Hist√≥rico cargado (${(data.items||[]).length}).`); }
        else { renderStatus(data.error || "No se pudo cargar el hist√≥rico.", "err"); }
      }catch(e){ renderStatus(e.message || "Error al cargar hist√≥rico.", "err"); }
    }

    async function handleAdd(){
      const { userId, token } = getCreds();
      if (!userId || !token){ renderStatus("Primero inicia sesi√≥n.", "err"); showModal(); return; }
      const w = normalize(el("peso").value);
      if (w==null || w<20 || w>400){ renderStatus("Introduce un peso v√°lido (20‚Äì400 kg).", "err"); el("peso").focus(); return; }
      el("addBtn").disabled = true; renderStatus("Guardando‚Ä¶");
      try{
        const data = await apiAdd(userId, token, w);
        if (data.ok){ el("peso").value=""; renderStatus("Registro guardado.", "ok"); await loadHistory(); }
        else { renderStatus(data.error || "No se pudo guardar.", "err"); }
      }catch(e){ renderStatus(e.message || "Error de red/servidor.", "err"); }
      finally{ el("addBtn").disabled = false; }
    }

    // Delegaci√≥n de clics para borrar
    document.addEventListener("click", async (e)=>{
      const btn = e.target.closest(".btn-del");
      if (!btn) return;
      const row = Number(btn.dataset.row);
      const date = btn.dataset.date;
      const weight = btn.dataset.weight;
      if (!Number.isFinite(row) || row<2){ renderStatus("Registro inv√°lido.", "err"); return; }
      if (!confirm(`¬øEliminar el registro del ${date} (${weight} kg)? Esta acci√≥n no se puede deshacer.`)) return;
      const { userId, token } = getCreds();
      if (!userId || !token){ renderStatus("Primero inicia sesi√≥n.", "err"); return; }
      btn.disabled = true; renderStatus("Eliminando‚Ä¶");
      try {
        const res = await apiDelete(userId, token, row);
        if (res.ok){ renderStatus("Registro eliminado.", "ok"); await loadHistory(); }
        else { renderStatus(res.error || "No se pudo eliminar.", "err"); }
      } catch(err){ renderStatus(err.message || "Error al eliminar.", "err"); }
      finally{ btn.disabled = false; }
    });

    // Modal helpers
    function hideModal(){ const m=el("loginModal"); if(!m) return; m.classList.add("hide"); m.style.display="none"; m.setAttribute("aria-hidden","true"); }
    function showModal(){ const m=el("loginModal"); if(!m) return; m.classList.remove("hide"); m.style.display="flex"; m.removeAttribute("aria-hidden"); }

    function syncCredsFromQuery(){
      const url = new URL(location.href);
      const u = url.searchParams.get("userId");
      const t = url.searchParams.get("token");
      if (u && t) setCreds({ userId:u, token:t });
    }

    async function updateAuthUI(){
      const { userId, token } = getCreds();
      const logged = !!(userId && token);
      if (logged){ hideModal(); el("logoutBtn").classList.remove("hide"); await loadHistory(); }
      else { showModal(); el("logoutBtn").classList.add("hide"); }
    }

    // ========= Init / eventos =========
    window.addEventListener("DOMContentLoaded", () => {
      renderToday();
      syncCredsFromQuery();
      updateAuthUI();

      el("loginForm")?.addEventListener("submit", (e) => {
        e.preventDefault();
        const userId = el("userId").value.trim();
        const token  = el("token").value.trim();
        if (!userId || !token){ renderStatus("Completa ID y token.", "err"); return; }
        setCreds({ userId, token }); hideModal(); el("logoutBtn").classList.remove("hide");
        renderStatus("Sesi√≥n iniciada. Cargando hist√≥rico‚Ä¶"); updateAuthUI();
      });

      el("logoutBtn").addEventListener("click", () => {
        clearCreds(); renderTable([]); renderStatus("Sesi√≥n cerrada."); showModal(); el("logoutBtn").classList.add("hide");
      });

      el("addBtn").addEventListener("click", handleAdd);
      el("peso").addEventListener("keydown", e => { if (e.key==="Enter") handleAdd(); });

      if (!okURL(APP_SCRIPT_URL)){ renderStatus("‚ö†Ô∏è APP_SCRIPT_URL no v√°lida (debe terminar en /exec).", "err"); }
    });

    window.addEventListener("error", ev => { console.error(ev.error || ev.message); renderStatus("Error: " + (ev.message || "consulta consola"), "err"); });
  </script>
</body>
</html>
